---
title: 复杂声明 | C语言
date: 2018-01-11 12:34:11
categories:
  - c语言
tags: 
  - c语言
abbrlink: aa2a2a8468f22a50
---

今天看了《C专家编程》里的'分析C语言的声明'一章，终于懂了C语言的复杂声明是怎么解析的。虽然在平时写代码的时候用到复杂声明的情况几乎没有，这里还是做一个记录，也是加深对C语言声明的理解。

# 声明的优先级规则

以下规则来自《C专家编程》。

C语言声明的优先级规则：

- A.    声明从它的名字开始读取，然后按照优先级顺序依次读取。
- B.    优先级从高到低依次是：
    - B1.   声明中被括号括起来的那部分。
    - B2.   后缀操作符：括号`()`表示**这是一个函数，函数返回值是xxx**；方括号`[]`表示**这是一个数组，数组包含xxx**。
    - B3.   前缀操作符：星号`*`表示**指向xxx的指针**。
- C.    如果const或volatile 关键字的后面紧跟类型说明符（如int,long等），那么它作用于类型说明符。在其他情况下，const和volatile 关键字作用于它左边紧邻的指针星号。

通过上述规则画出一个神奇的声明解析环：
![image](http://qiniu.wangjinle.com/C_declaration.png)

# 例子1

看一个例子：`char *(*next)();`

用优先级规则来解读一下：
- 找到它的名字，是**next**，注意到离next最近的是`*`与`()`
- B1规则告诉我们`()`优先级最高，我们把括号里的东西作为一个整体，通过B3规则，我们得到**next是一个指针，指向xxx**
- 考虑括号外面的东西。在`*`与`()`间作出选择，B2优先于B3。所以**next是一个指针，指向一个函数，它的返回值是xxx**
- 然后，处理`*`，得到**next是一个指针，指向一个函数，它的返回值是一个指针，指针指向xxx**
- 最后，处理`char`，得到**next是一个指针，指向一个函数，它的返回值是一个指针，指针指向char类型**.

把上述结果总结一下就是：**next是一个指针，它指向一个函数，该函数的返回值是一个char类型的指针**。

# 例子2

例子`const char *str[10];`：

- 找到名字，是**str**
- 考虑`*`与`[]`的优化级，`[]`优先于`*`，所以**str是一个数组，它包含10个xxx**
- 然后，处理`*`，所以**str是一个数组，它包含了10个指向xxx的指针**
- 最后根据C规则，处理`const char`，**next是一个数组，它包含了10个指向const char类型的指针**

如果是`char * const str[10];`：
- 找到名字，是**str**
- 处理`[]`，所以**str是一个数组，它包含10个xxx**
- 处理`const`，根据C规则const修饰*，那么**str是一个数组，它包含了10个指向xxx的const指针**
- 处理`char`，**next是一个数组，它包含了10个指向char类型的const指针**

# 例子3

来一个复杂一点的例子`char *(* test[10])(int p)`：

- 名字是**test**
- test被`()`包围，先处理`()`内部。
- 结合`[]`，**test是一个包含10个xxx的数组**
- 结合`*`，**test是一个包含10个指向xxx指针的数组**
- 处理`()`外部，结合`(int p)`，**test是一个包含10个指针的数组，这些指针们指向一个函数，该函数有参数`int p`**
- 处理`*`，**test是一个包含10个指针的数组，这些指针们各自指向一个函数，该函数有参数`int p`且返回一个指针**
- 处理`char`，**test是一个包含10个指针的数组，这些指针们各自指向一个函数，该函数有参数`int p`且返回一个指向char类型的指针**

# typedef 简化复杂声明

typedef的功能是为一个类型引入新的名字。当需要使用到复杂声明的时候，使用typedef可以简单声明。典型的例子是`signal()`原型的声明。`signal()`原型是一种系统调用，用于通知运行时系统有“软件中断”产生。

`signal()`的声明如下：`void (*signal(int sig, void(*func)(int)))(int);`。运用上面的声明解析，得到它的意思如下：
`void (*signal(    ))(int);`，signal是一个函数，它返回一个函数指针，后者所指向的函数接受一个int参数并返回void。`signal`有两个参数，其中一个恐怖的参数和返回值是同一类型：`void (*func)(int)`。

上述声明可以使用typedef来简化，让我们用typedef来表示通用部分：
```c
/*
 * 表示ptr_to_func是一个函数指针，指向一个参数为int，返回值为void的函数。
 */
typedef void (* ptr_to_func)(int);

/*
 * 表示signal是一个函数，它接受两个参数，一个是int，一个是ptr_to_func，返回值为ptr_to_func。
 */
ptr_to_func signal(int, ptr_to_func);
```

# 参考

- 《C专家编程》
- C语言复杂声明的解析器：[cdecl](https://cdecl.org/)
- [C语言汇总](http://blog.wangjinle.com/posts/53291f7288071263.html)

